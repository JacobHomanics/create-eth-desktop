name: Build & Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      
      # Code signing and notarization (if certificates are available)
      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        continue-on-error: true
      
      - name: Build macOS app
        run: |
          # Only enable notarization if all required secrets are present
          if [ -n "${{ secrets.APPLE_TEAM_ID }}" ] && [ -n "${{ secrets.APPLE_ID }}" ] && [ -n "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" ]; then
            echo "Building with notarization..."
            npm run dist:mac -- --config.mac.notarize.teamId="${{ secrets.APPLE_TEAM_ID }}"
          else
            echo "Notarization credentials not set, building without notarization..."
            npm run dist:mac -- --config.mac.notarize=null
          fi
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Upload mac artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-electron/**/*.dmg
            dist-electron/**/*.zip

  win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run dist:win

      - name: Upload Windows artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-electron/**/*.exe
            dist-electron/**/*.msi

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run dist:linux

      - name: Upload Linux artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-electron/**/*.AppImage
            dist-electron/**/*.deb
